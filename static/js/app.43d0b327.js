(function(){"use strict";var e={8263:function(e,s,t){var n=t(9963),r=t(6252);function o(e,s,t,n,o,i){const a=(0,r.up)("router-view");return(0,r.wg)(),(0,r.j4)(a)}var i={name:"App"},a=t(3744);const c=(0,a.Z)(i,[["render",o]]);var u=c,l=t(2119);const m={class:"home-container"},d={class:"sidebar"},h={class:"main"};function f(e,s,t,n,o,i){const a=(0,r.up)("card"),c=(0,r.up)("list"),u=(0,r.up)("message"),l=(0,r.up)("chat-text");return(0,r.wg)(),(0,r.iD)("div",m,[e.$store.state.user?((0,r.wg)(),(0,r.iD)(r.HY,{key:0},[(0,r._)("div",d,[(0,r.Wm)(a),(0,r.Wm)(c)]),(0,r._)("div",h,[(0,r.Wm)(u),(0,r.Wm)(l)])],64)):(0,r.kq)("",!0)])}var g=t(3577);const v={class:"card"},_=["alt","src"],p={class:"name"};function S(e,s,t,n,o,i){return(0,r.wg)(),(0,r.iD)("div",v,[(0,r._)("header",null,[(0,r._)("img",{class:"avatar",width:"40",height:"40",alt:i.user.username,src:e.$socket.server_host+i.user.avatar},null,8,_),(0,r._)("p",p,(0,g.zw)(i.user.username),1)])])}var w={name:"card-",computed:{user(){return this.$store.state.user}}};const E=(0,a.Z)(w,[["render",S],["__scopeId","data-v-7fef8955"]]);var k=E;const y={class:"list"},$=["onClick"],b=["alt","src"],O={class:"name"};function D(e,s,t,n,o,i){const a=(0,r.up)("el-badge");return(0,r.wg)(),(0,r.iD)("div",y,[(0,r._)("ul",null,[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(i.sessions,(s=>((0,r.wg)(),(0,r.iD)("li",{onClick:e=>i.onSelectSession(s),class:(0,g.C_)({active:i.current_session&&s.user.sid==i.current_session.user.sid}),key:s.user.sid},[(0,r._)("img",{class:"avatar",width:"30",height:"30",alt:s.user.username,src:e.$socket.server_host+s.user.avatar},null,8,b),(0,r.Wm)(a,{value:s.unread,class:"item",hidden:0==s.unread},{default:(0,r.w5)((()=>[(0,r._)("p",O,(0,g.zw)(s.user.username)+"("+(0,g.zw)(s.user.ip)+")",1)])),_:2},1032,["value","hidden"])],10,$)))),128))])])}var T={name:"list-",computed:{sessions(){return this.$store.state.sessions},current_session(){return this.$store.state.current_session}},mounted(){this.$socket.onUserOnline((e=>{let s=e.user;this.$store.commit("ADD_SESSION",s)})),this.$socket.onUserOffine((e=>{const s=e.user;this.$store.commit("DELETE_SESSION",s)}))},methods:{onSelectSession(e){this.$store.commit("SET_CURRENT_SESSION",e)}}};const I=(0,a.Z)(T,[["render",D],["__scopeId","data-v-176edf28"]]);var C=I;const x={class:"text"};function M(e,s,t,o,i,a){return(0,r.wg)(),(0,r.iD)("div",x,[(0,r.wy)((0,r._)("textarea",{placeholder:"按 Ctrl + Enter 發送","onUpdate:modelValue":s[0]||(s[0]=e=>i.content=e),onKeyup:s[1]||(s[1]=(...e)=>a.onKeyup&&a.onKeyup(...e))},null,544),[[n.nr,i.content]])])}var N=t(1348),U={name:"chat-text",computed:{current_session(){return this.$store.state.current_session}},data(){return{content:""}},methods:{onKeyup(e){if(e.ctrlKey&&13===e.keyCode&&this.content.length){if(!this.current_session)return void N.z8.info("請先選擇聊天對象");const e=this.content;this.$socket.emitSendMessage({to:this.current_session.user.sid,message:this.content},(s=>{200==s["code"]&&(console.log(s),console.log(e),this.$store.commit("SEND_MESSAGE",e))})),this.content=""}}}};const R=(0,a.Z)(U,[["render",M],["__scopeId","data-v-b65bb798"]]);var W=R;const j={class:"message",ref:"el"},z={key:0},Z={class:"time"},A=["src"],K={class:"text"};function F(e,s,t,n,o,i){return(0,r.wg)(),(0,r.iD)("div",j,[i.current_session?((0,r.wg)(),(0,r.iD)("ul",z,[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(i.current_session.messages,((e,s)=>((0,r.wg)(),(0,r.iD)("li",{key:s},[(0,r._)("p",Z,[(0,r._)("span",null,(0,g.zw)(i.timeFormat(e.date)),1)]),(0,r._)("div",{class:(0,g.C_)({main:!0,self:e.self})},[(0,r._)("img",{class:"avatar",width:"30",height:"30",src:e.self?i.avatarFormat(i.user.avatar):i.avatarFormat(i.current_session.user.avatar)},null,8,A),(0,r._)("div",K,(0,g.zw)(e.content),1)],2)])))),128))])):(0,r.kq)("",!0)],512)}var H={name:"message-",computed:{current_session(){return this.$store.state.current_session},user(){return this.$store.state.user}},mounted(){this.$socket.onReceiveMessage((e=>{const s=e["from"],t=e["message"];this.$store.commit("RECEIVE_MESSAGE",{sid:s,content:t})}))},methods:{timeFormat(e){return"string"===typeof e&&(e=new Date(e)),e.getHours()+":"+e.getMinutes()},avatarFormat(e){return this.$socket.server_host+e}},updated(){this.$nextTick((()=>{var e=this.$refs.el;e.scrollTop=e.scrollHeight}))}};const V=(0,a.Z)(H,[["render",F],["__scopeId","data-v-040dac69"]]);var P=V,G={name:"Home-",created(){},mounted(){this.$store.getters.logined||this.$router.push("/login")},components:{card:k,list:C,[W.name]:W,message:P}};const L=(0,a.Z)(G,[["render",f],["__scopeId","data-v-2afee32c"]]);var Y=L;const q=e=>((0,r.dD)("data-v-1057789e"),e=e(),(0,r.Cn)(),e),B={class:"login-container"},J=q((()=>(0,r._)("h1",{style:{"text-align":"center"}},"聊天系統",-1))),Q=(0,r.Uk)("登入");function X(e,s,t,n,o,i){const a=(0,r.up)("el-input"),c=(0,r.up)("el-form-item"),u=(0,r.up)("el-button"),l=(0,r.up)("el-form");return(0,r.wg)(),(0,r.iD)("div",B,[(0,r.Wm)(l,{ref:"form",model:o.form,class:"login-main"},{default:(0,r.w5)((()=>[J,(0,r.Wm)(c,null,{default:(0,r.w5)((()=>[(0,r.Wm)(a,{modelValue:o.form.username,"onUpdate:modelValue":s[0]||(s[0]=e=>o.form.username=e),placeholder:"請輸入用戶名"},null,8,["modelValue"])])),_:1}),(0,r.Wm)(c,{style:{"text-align":"right"}},{default:(0,r.w5)((()=>[(0,r.Wm)(u,{type:"primary",onClick:i.onSubmit},{default:(0,r.w5)((()=>[Q])),_:1},8,["onClick"])])),_:1})])),_:1},8,["model"])])}var ee={name:"Login-",data(){return{form:{username:""}}},mounted(){},methods:{onSubmit(){this.form.username?(this.$socket.connected&&this.$socket.connect(),this.$socket.emitlogin(this.form.username,(e=>{if(200===e["code"]){const s=e["data"],t=s["user"],n=s["online_users"];this.$store.commit("SET_USER",t),this.$store.commit("SET_SESSIONS",n),this.$router.push({name:"home"})}else N.z8.error(e["message"])}))):N.z8.error("請輸入用戶名")}}};const se=(0,a.Z)(ee,[["render",X],["__scopeId","data-v-1057789e"]]);var te=se;const ne=[{path:"/",component:Y,name:"home"},{path:"/login",component:te,name:"login"}],re=(0,l.p7)({history:(0,l.r5)(),routes:ne});var oe=re,ie=t(5273),ae=(t(4415),t(9367));class ce{constructor(){this.server_host=window.location.origin,this.socket=(0,ae.io)(this.server_host)}connect(){this.socket.connect()}emitlogin(e,s){this.socket.emit("login",{username:e},(e=>{s&&s(e)}))}onUserOnline(e){this.socket.on("user online",(s=>{e&&e(s)}))}onUserOffine(e){this.socket.on("user offline",(s=>{e&&e(s)}))}emitSendMessage(e,s){this.socket.emit("send message",{to:e["to"],message:e["message"]},(e=>{s&&s(e)}))}onReceiveMessage(e){this.socket.on("receive message",(s=>{e&&e(s)}))}get connected(){return this.socket.connected}}var ue=new ce,le=t(3907);const me=(0,le.MT)({state:{user:null,sessions:[],current_session:null},mutations:{SET_USER(e,s){e.user=s},ADD_SESSION(e,s){e.sessions.push({user:s,messages:[],unread:0})},SET_SESSIONS(e,s){const t=[];for(let n of s)t.push({user:n,messages:[],unread:0});e.sessions=t},SET_CURRENT_SESSION(e,s){s.unread=0,e.current_session=s},DELETE_SESSION(e,s){for(let t=0;t<e.sessions.length;t++){let n=e.sessions[t];if(n.user.sid==s.sid){e.sessions.splice(t,1),e.current_session.user.sid==n.user.sid&&(e.current_session=null);break}}},SEND_MESSAGE(e,s){e.current_session&&e.current_session.messages.push({content:s,date:new Date,self:!0})},RECEIVE_MESSAGE(e,s){console.log(s);const t=s["sid"],n=s["content"];let r=null;for(let o of e.sessions)if(o.user.sid==t){r=o;break}r&&(r.messages.push({content:n,date:new Date,self:!1}),e.current_session&&e.current_session.user.sid==r.user.sid||(r.unread+=1))}},getters:{logined(e){return!!e.user}}});var de=me;const he=(0,n.ri)(u);he.use(oe),he.use(ie.Z),he.use(de),he.config.globalProperties.$socket=ue,he.mount("#app")}},s={};function t(n){var r=s[n];if(void 0!==r)return r.exports;var o=s[n]={exports:{}};return e[n].call(o.exports,o,o.exports,t),o.exports}t.m=e,function(){var e=[];t.O=function(s,n,r,o){if(!n){var i=1/0;for(l=0;l<e.length;l++){n=e[l][0],r=e[l][1],o=e[l][2];for(var a=!0,c=0;c<n.length;c++)(!1&o||i>=o)&&Object.keys(t.O).every((function(e){return t.O[e](n[c])}))?n.splice(c--,1):(a=!1,o<i&&(i=o));if(a){e.splice(l--,1);var u=r();void 0!==u&&(s=u)}}return s}o=o||0;for(var l=e.length;l>0&&e[l-1][2]>o;l--)e[l]=e[l-1];e[l]=[n,r,o]}}(),function(){t.d=function(e,s){for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})}}(),function(){t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){t.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)}}(),function(){t.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={143:0};t.O.j=function(s){return 0===e[s]};var s=function(s,n){var r,o,i=n[0],a=n[1],c=n[2],u=0;if(i.some((function(s){return 0!==e[s]}))){for(r in a)t.o(a,r)&&(t.m[r]=a[r]);if(c)var l=c(t)}for(s&&s(n);u<i.length;u++)o=i[u],t.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return t.O(l)},n=self["webpackChunkserver_client"]=self["webpackChunkserver_client"]||[];n.forEach(s.bind(null,0)),n.push=s.bind(null,n.push.bind(n))}();var n=t.O(void 0,[998],(function(){return t(8263)}));n=t.O(n)})();